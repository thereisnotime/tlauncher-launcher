name: Container Build & Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-docker:
    name: Build with Docker
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build container image
      run: |
        docker build -f Containerfile -t tlauncher-java:test .

    - name: Test image
      run: |
        docker images | grep tlauncher-java
        docker inspect tlauncher-java:test

    - name: Validate Compose files
      run: |
        # Set dummy environment variables for validation
        export DISPLAY=:0
        export XAUTHORITY=/tmp/.Xauthority
        export USER=testuser

        # Test compose file syntax
        docker compose -f compose.base.yaml config > /dev/null
        docker compose -f compose.base.yaml -f compose.docker.yaml -f compose.nvidia.yaml -f compose.x11.yaml -f compose.audio-pulseaudio.yaml config > /dev/null
        echo "✓ Compose files validated"

  build-podman:
    name: Build with Podman
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman

    - name: Build container image
      run: |
        podman build -f Containerfile -t tlauncher-java:test .

    - name: Test image
      run: |
        podman images | grep tlauncher-java
        podman inspect tlauncher-java:test

    - name: Validate Compose files
      run: |
        # Set dummy environment variables for validation
        export DISPLAY=:0
        export XAUTHORITY=/tmp/.Xauthority
        export USER=testuser

        # Test compose file syntax
        podman compose -f compose.base.yaml config > /dev/null || echo "⚠️ Podman compose validation skipped (may not be available)"

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check required files
      run: |
        test -f Containerfile || (echo "❌ Containerfile missing" && exit 1)
        test -f entrypoint.sh || (echo "❌ entrypoint.sh missing" && exit 1)
        test -f minecraft.py || (echo "❌ minecraft.py missing" && exit 1)
        test -f gui.py || (echo "❌ gui.py missing" && exit 1)
        test -f cli.py || (echo "❌ cli.py missing" && exit 1)
        test -f requirements.txt || (echo "❌ requirements.txt missing" && exit 1)
        echo "✓ All required files present"

    - name: Check compose files
      run: |
        ls compose.*.yaml | wc -l | grep -q "9" || (echo "❌ Expected 9 compose files" && exit 1)
        echo "✓ All compose files present"

    - name: Verify Python syntax
      run: |
        python3 -m py_compile minecraft.py
        python3 -m py_compile gui.py
        python3 -m py_compile cli.py
        python3 -m py_compile core/*.py
        echo "✓ Python syntax valid"
